#
# The Python Imaging Library.
# $Id$
#
# DCX file handling
#
# DCX is a container file format defined by Intel, commonly used
# for fax applications.  Each DCX file consists of a directory
# (a list of file offsets) followed by a set of (usually 1-bit)
# PCX files.
#
# History:
# 1995-09-09 fl   Created
# 1996-03-20 fl   Properly derived from PcxImageFile.
# 1998-07-15 fl   Renamed offset attribute to avoid name clash
# 2002-07-30 fl   Fixed file handling
#
# Copyright (c) 1997-98 by Secret Labs AB.
# Copyright (c) 1995-96 by Fredrik Lundh.
#
# See the README file for information on usage and redistribution.
#
<<<<<<< HEAD
=======
from __future__ import annotations
>>>>>>> 32e7214c1350fb4a88064960159c92207483e581

from . import Image
from ._binary import i32le as i32
from .PcxImagePlugin import PcxImageFile

MAGIC = 0x3ADE68B1  # QUIZ: what's this value, then?


<<<<<<< HEAD
def _accept(prefix):
=======
def _accept(prefix: bytes) -> bool:
>>>>>>> 32e7214c1350fb4a88064960159c92207483e581
    return len(prefix) >= 4 and i32(prefix) == MAGIC


##
# Image plugin for the Intel DCX format.


class DcxImageFile(PcxImageFile):
<<<<<<< HEAD

=======
>>>>>>> 32e7214c1350fb4a88064960159c92207483e581
    format = "DCX"
    format_description = "Intel DCX"
    _close_exclusive_fp_after_loading = False

<<<<<<< HEAD
    def _open(self):

        # Header
        s = self.fp.read(4)
        if not _accept(s):
            raise SyntaxError("not a DCX file")
=======
    def _open(self) -> None:
        # Header
        s = self.fp.read(4)
        if not _accept(s):
            msg = "not a DCX file"
            raise SyntaxError(msg)
>>>>>>> 32e7214c1350fb4a88064960159c92207483e581

        # Component directory
        self._offset = []
        for i in range(1024):
            offset = i32(self.fp.read(4))
            if not offset:
                break
            self._offset.append(offset)

<<<<<<< HEAD
        self.__fp = self.fp
        self.frame = None
=======
        self._fp = self.fp
        self.frame = -1
>>>>>>> 32e7214c1350fb4a88064960159c92207483e581
        self.n_frames = len(self._offset)
        self.is_animated = self.n_frames > 1
        self.seek(0)

<<<<<<< HEAD
    def seek(self, frame):
        if not self._seek_check(frame):
            return
        self.frame = frame
        self.fp = self.__fp
        self.fp.seek(self._offset[frame])
        PcxImageFile._open(self)

    def tell(self):
        return self.frame

    def _close__fp(self):
        try:
            if self.__fp != self.fp:
                self.__fp.close()
        except AttributeError:
            pass
        finally:
            self.__fp = None

=======
    def seek(self, frame: int) -> None:
        if not self._seek_check(frame):
            return
        self.frame = frame
        self.fp = self._fp
        self.fp.seek(self._offset[frame])
        PcxImageFile._open(self)

    def tell(self) -> int:
        return self.frame

>>>>>>> 32e7214c1350fb4a88064960159c92207483e581

Image.register_open(DcxImageFile.format, DcxImageFile, _accept)

Image.register_extension(DcxImageFile.format, ".dcx")
