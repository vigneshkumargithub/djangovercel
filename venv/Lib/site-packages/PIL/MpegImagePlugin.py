#
# The Python Imaging Library.
# $Id$
#
# MPEG file handling
#
# History:
#       95-09-09 fl     Created
#
# Copyright (c) Secret Labs AB 1997.
# Copyright (c) Fredrik Lundh 1995.
#
# See the README file for information on usage and redistribution.
#
<<<<<<< HEAD


from . import Image, ImageFile
from ._binary import i8
=======
from __future__ import annotations

from . import Image, ImageFile
from ._binary import i8
from ._typing import SupportsRead
>>>>>>> 32e7214c1350fb4a88064960159c92207483e581

#
# Bitstream parser


class BitStream:
<<<<<<< HEAD
    def __init__(self, fp):
=======
    def __init__(self, fp: SupportsRead[bytes]) -> None:
>>>>>>> 32e7214c1350fb4a88064960159c92207483e581
        self.fp = fp
        self.bits = 0
        self.bitbuffer = 0

<<<<<<< HEAD
    def next(self):
        return i8(self.fp.read(1))

    def peek(self, bits):
=======
    def next(self) -> int:
        return i8(self.fp.read(1))

    def peek(self, bits: int) -> int:
>>>>>>> 32e7214c1350fb4a88064960159c92207483e581
        while self.bits < bits:
            c = self.next()
            if c < 0:
                self.bits = 0
                continue
            self.bitbuffer = (self.bitbuffer << 8) + c
            self.bits += 8
        return self.bitbuffer >> (self.bits - bits) & (1 << bits) - 1

<<<<<<< HEAD
    def skip(self, bits):
=======
    def skip(self, bits: int) -> None:
>>>>>>> 32e7214c1350fb4a88064960159c92207483e581
        while self.bits < bits:
            self.bitbuffer = (self.bitbuffer << 8) + i8(self.fp.read(1))
            self.bits += 8
        self.bits = self.bits - bits

<<<<<<< HEAD
    def read(self, bits):
=======
    def read(self, bits: int) -> int:
>>>>>>> 32e7214c1350fb4a88064960159c92207483e581
        v = self.peek(bits)
        self.bits = self.bits - bits
        return v


<<<<<<< HEAD
=======
def _accept(prefix: bytes) -> bool:
    return prefix[:4] == b"\x00\x00\x01\xb3"


>>>>>>> 32e7214c1350fb4a88064960159c92207483e581
##
# Image plugin for MPEG streams.  This plugin can identify a stream,
# but it cannot read it.


class MpegImageFile(ImageFile.ImageFile):
<<<<<<< HEAD

    format = "MPEG"
    format_description = "MPEG"

    def _open(self):

        s = BitStream(self.fp)

        if s.read(32) != 0x1B3:
            raise SyntaxError("not an MPEG file")

        self.mode = "RGB"
=======
    format = "MPEG"
    format_description = "MPEG"

    def _open(self) -> None:
        assert self.fp is not None

        s = BitStream(self.fp)
        if s.read(32) != 0x1B3:
            msg = "not an MPEG file"
            raise SyntaxError(msg)

        self._mode = "RGB"
>>>>>>> 32e7214c1350fb4a88064960159c92207483e581
        self._size = s.read(12), s.read(12)


# --------------------------------------------------------------------
# Registry stuff

<<<<<<< HEAD
Image.register_open(MpegImageFile.format, MpegImageFile)
=======
Image.register_open(MpegImageFile.format, MpegImageFile, _accept)
>>>>>>> 32e7214c1350fb4a88064960159c92207483e581

Image.register_extensions(MpegImageFile.format, [".mpg", ".mpeg"])

Image.register_mime(MpegImageFile.format, "video/mpeg")
